name: ðŸŽ° Sync Lottery Data

on:
  schedule:
    # Executa diariamente Ã s 06:00 UTC (03:00 BrasÃ­lia)
    - cron: "0 6 * * *"

  # Permite execuÃ§Ã£o manual
  workflow_dispatch:

jobs:
  sync-lottery-data:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: ðŸ“¦ Install dependencies
        run: npm install

      - name: ðŸŽ¯ Run lottery sync
        run: node scripts/sync-local.js

      - name: ðŸ“Š Check for changes
        id: verify-changed-files
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ˆ Novos dados encontrados!"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "âœ… Dados jÃ¡ estÃ£o atualizados"
          fi

      - name: ðŸ’¾ Commit and push changes
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          git add public/data/*.json

          # Cria mensagem de commit com estatÃ­sticas
          LOTOFACIL_COUNT=$(jq '.metadata.totalDraws' public/data/lotofacil.json)
          MEGASENA_COUNT=$(jq '.metadata.totalDraws' public/data/megasena.json)

          git commit -m "ðŸŽ° Auto-sync lottery data

          ðŸ“Š LotofÃ¡cil: ${LOTOFACIL_COUNT} concursos
          ðŸŽ¯ Mega-Sena: ${MEGASENA_COUNT} concursos
          ðŸ• Sync: $(date -u +'%Y-%m-%d %H:%M:%S UTC')

          [skip ci]"

          git push

      - name: ðŸ“‹ Create summary
        run: |
          echo "## ðŸŽ° Lottery Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.verify-changed-files.outputs.changed }}" == "true" ]; then
            echo "âœ… **Status**: Novos dados sincronizados com sucesso!" >> $GITHUB_STEP_SUMMARY
            
            LOTOFACIL_COUNT=$(jq '.metadata.totalDraws' public/data/lotofacil.json)
            MEGASENA_COUNT=$(jq '.metadata.totalDraws' public/data/megasena.json)
            LAST_UPDATE=$(jq -r '.metadata.lastUpdate' public/data/lotofacil.json)
            
            echo "ðŸ“Š **LotofÃ¡cil**: ${LOTOFACIL_COUNT} concursos" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ¯ **Mega-Sena**: ${MEGASENA_COUNT} concursos" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ• **Ãšltima atualizaÃ§Ã£o**: ${LAST_UPDATE}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš€ **Deploy**: Vercel farÃ¡ deploy automÃ¡tico dos novos dados" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **Status**: Todos os dados jÃ¡ estÃ£o atualizados" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ¯ Nenhuma aÃ§Ã£o necessÃ¡ria" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Links Ãºteis**:" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ“Š Status da aplicaÃ§Ã£o](https://loterias.guiadainternet.com/status.html)" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸŽ° AplicaÃ§Ã£o principal](https://loterias.guiadainternet.com)" >> $GITHUB_STEP_SUMMARY
